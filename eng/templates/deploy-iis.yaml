# Copyright (c) 2026 Mud MCP Contributors
# Licensed under the GNU General Public License v2.0. See LICENSE file in the project root for full license information.

# IIS Deployment Template for MudBlazor MCP Server
# Reusable template for deploying to IIS on Windows VMs

parameters:
  - name: artifactName
    type: string
    displayName: 'Artifact name to deploy'
  - name: websiteName
    type: string
    displayName: 'IIS Website name'
  - name: appPoolName
    type: string
    displayName: 'IIS Application Pool name'
  - name: physicalPath
    type: string
    displayName: 'Physical path on the server'
  - name: environment
    type: string
    displayName: 'ASP.NET Core environment'
    default: 'Production'
  - name: port
    type: number
    displayName: 'HTTP port for the website'
    default: 5180

steps:
  # Checkout source to get deployment scripts
  # Deployment jobs don't automatically have source code - only artifacts are downloaded
  - checkout: self
    displayName: 'Checkout deployment scripts'
    fetchDepth: 1

  - task: DownloadPipelineArtifact@2
    displayName: 'Download MudBlazor.Mcp build artifact'
    inputs:
      buildType: 'current'
      artifactName: '${{ parameters.artifactName }}'
      targetPath: '$(Pipeline.Workspace)/${{ parameters.artifactName }}'

  - task: PowerShell@2
    displayName: 'Stop IIS Application Pool'
    inputs:
      targetType: 'filePath'
      filePath: '$(Build.SourcesDirectory)/eng/scripts/Stop-IisSiteAndAppPool.ps1'
      arguments: '-AppPoolName "${{ parameters.appPoolName }}"'
      errorActionPreference: 'continue'

  - task: PowerShell@2
    displayName: 'Backup current deployment'
    inputs:
      targetType: 'filePath'
      filePath: '$(Build.SourcesDirectory)/eng/scripts/Backup-Deployment.ps1'
      arguments: '-PhysicalPath "${{ parameters.physicalPath }}" -MaxBackups 3'
      errorActionPreference: 'continue'

  - task: PowerShell@2
    displayName: 'Deploy application files'
    inputs:
      targetType: 'filePath'
      filePath: '$(Build.SourcesDirectory)/eng/scripts/Deploy-IisContent.ps1'
      arguments: '-ArtifactPath "$(Pipeline.Workspace)/${{ parameters.artifactName }}" -PhysicalPath "${{ parameters.physicalPath }}"'

  - task: PowerShell@2
    displayName: 'Configure IIS Website and Application Pool'
    inputs:
      targetType: 'filePath'
      filePath: '$(Build.SourcesDirectory)/eng/scripts/Configure-IisWebsite.ps1'
      arguments: '-WebsiteName "${{ parameters.websiteName }}" -AppPoolName "${{ parameters.appPoolName }}" -PhysicalPath "${{ parameters.physicalPath }}" -Port ${{ parameters.port }}'

  - task: PowerShell@2
    displayName: 'Update environment settings'
    inputs:
      targetType: 'filePath'
      filePath: '$(Build.SourcesDirectory)/eng/scripts/Update-EnvironmentSettings.ps1'
      arguments: '-PhysicalPath "${{ parameters.physicalPath }}" -Environment "${{ parameters.environment }}"'

  - task: PowerShell@2
    displayName: 'Set folder permissions'
    inputs:
      targetType: 'filePath'
      filePath: '$(Build.SourcesDirectory)/eng/scripts/Set-IisFolderPermissions.ps1'
      arguments: '-PhysicalPath "${{ parameters.physicalPath }}" -AppPoolName "${{ parameters.appPoolName }}"'

  - task: PowerShell@2
    displayName: 'Start IIS Application Pool and Website'
    inputs:
      targetType: 'filePath'
      filePath: '$(Build.SourcesDirectory)/eng/scripts/Start-IisSiteAndAppPool.ps1'
      arguments: '-AppPoolName "${{ parameters.appPoolName }}" -WebsiteName "${{ parameters.websiteName }}"'

  - task: PowerShell@2
    displayName: 'Verify deployment health'
    inputs:
      targetType: 'filePath'
      filePath: '$(Build.SourcesDirectory)/eng/scripts/Test-DeploymentHealth.ps1'
      arguments: '-Port ${{ parameters.port }} -AppPoolName "${{ parameters.appPoolName }}" -PhysicalPath "${{ parameters.physicalPath }}" -MaxRetries 6 -RetryDelaySeconds 10'
