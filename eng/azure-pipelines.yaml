# Copyright (c) 2026 Mud MCP Contributors
# Licensed under the GNU General Public License v2.0. See LICENSE file in the project root for full license information.

# Azure DevOps Pipeline for MudBlazor MCP Server
# Builds, tests, and deploys to IIS on a VM environment

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - src/**
      - tests/**
      - eng/**
      - Directory.Build.props
      - Directory.Packages.props
      - global.json
      - nuget.config
      - '*.sln*'

pr:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - src/**
      - tests/**
      - Directory.Build.props
      - Directory.Packages.props
      - global.json
      - nuget.config
      - '*.sln*'

variables:
  - name: buildConfiguration
    value: 'Release'
  - name: dotnetVersion
    value: '10.x'
  - name: projectPath
    value: 'src/MudBlazor.Mcp/MudBlazor.Mcp.csproj'
  - name: testProjectPath
    value: 'tests/MudBlazor.Mcp.Tests/MudBlazor.Mcp.Tests.csproj'
  - name: publishPath
    value: '$(Build.ArtifactStagingDirectory)/publish'
  - name: artifactName
    value: 'mudblazor-mcp-server'
  - name: NUGET_PACKAGES
    value: '$(Pipeline.Workspace)/.nuget/packages'
  # IIS Configuration
  - name: iisWebsiteName
    value: 'MudBlazorMcp'
  - name: iisAppPoolName
    value: 'MudBlazorMcpPool'
  - name: iisPhysicalPath
    value: 'C:\inetpub\wwwroot\MudBlazorMcp'

stages:
  # ============================================
  # Stage: Build and Test
  # ============================================
  - stage: Build
    displayName: 'Build and Test'
    jobs:
      - job: BuildAndTest
        displayName: 'Build, Test, and Publish'
        pool:
          vmImage: 'windows-latest'
        
        steps:
          # Checkout with full history for versioning
          - checkout: self
            displayName: 'Checkout repository'
            fetchDepth: 0

          # Install .NET SDK
          - task: UseDotNet@2
            displayName: 'Install .NET $(dotnetVersion) SDK'
            inputs:
              version: '$(dotnetVersion)'
              includePreviewVersions: true

          # Cache NuGet packages
          - task: Cache@2
            displayName: 'Cache NuGet packages'
            inputs:
              key: 'nuget | "$(Agent.OS)" | Directory.Packages.props | **/**.csproj'
              restoreKeys: |
                nuget | "$(Agent.OS)" | Directory.Packages.props
                nuget | "$(Agent.OS)"
              path: $(NUGET_PACKAGES)

          # Restore dependencies
          - task: DotNetCoreCLI@2
            displayName: 'Restore dependencies'
            inputs:
              command: 'restore'
              projects: '**/*.csproj'
              feedsToUse: 'config'
              nugetConfigPath: 'nuget.config'

          # Build solution
          - task: DotNetCoreCLI@2
            displayName: 'Build solution'
            inputs:
              command: 'build'
              projects: '**/*.csproj'
              arguments: '--configuration $(buildConfiguration) --no-restore'

          # Run unit tests with code coverage
          # IMPORTANT: Do NOT add --logger or --results-directory arguments manually.
          # The DotNetCoreCLI@2 task with publishTestResults: true automatically adds:
          #   --logger trx --results-directory $(Agent.TempDirectory)
          # Adding these manually causes "expects a single argument but 2 were provided" errors.
          - task: DotNetCoreCLI@2
            displayName: 'Run unit tests'
            inputs:
              command: 'test'
              projects: '$(testProjectPath)'
              arguments: '--configuration $(buildConfiguration) --no-build --collect:"XPlat Code Coverage"'
              publishTestResults: true
              testRunTitle: 'MudBlazor.Mcp Unit Tests'

          - task: PublishCodeCoverageResults@2
            displayName: 'Publish code coverage'
            inputs:
              summaryFileLocation: '$(Agent.TempDirectory)/*/coverage.cobertura.xml'
              failIfCoverageEmpty: false

          # Run Pester tests for PowerShell deployment scripts
          - task: PowerShell@2
            displayName: 'Run Pester tests for deployment scripts'
            inputs:
              targetType: 'inline'
              script: |
                # Install Pester module (version 5.x)
                Install-Module -Name Pester -MinimumVersion 5.0 -Force -SkipPublisherCheck -Scope CurrentUser
                
                # Run Pester tests
                $pesterConfig = New-PesterConfiguration
                $pesterConfig.Run.Path = '$(Build.SourcesDirectory)/eng/scripts/Common'
                $pesterConfig.Run.Exit = $true
                $pesterConfig.Output.Verbosity = 'Detailed'
                $pesterConfig.TestResult.Enabled = $true
                $pesterConfig.TestResult.OutputPath = '$(Agent.TempDirectory)/PesterResults.xml'
                $pesterConfig.TestResult.OutputFormat = 'NUnitXml'
                
                Invoke-Pester -Configuration $pesterConfig

          # Publish Pester test results
          - task: PublishTestResults@2
            displayName: 'Publish Pester test results'
            condition: succeededOrFailed()
            inputs:
              testResultsFormat: 'NUnit'
              testResultsFiles: '$(Agent.TempDirectory)/PesterResults.xml'
              testRunTitle: 'PowerShell Pester Tests'
              failTaskOnFailedTests: true

          # Publish application
          - task: DotNetCoreCLI@2
            displayName: 'Publish application'
            inputs:
              command: 'publish'
              projects: '$(projectPath)'
              arguments: '--configuration $(buildConfiguration) --output $(publishPath) --no-build'
              publishWebProjects: false
              zipAfterPublish: false

          # Copy web.config for IIS hosting
          - task: PowerShell@2
            displayName: 'Prepare IIS configuration'
            inputs:
              targetType: 'filePath'
              filePath: '$(Build.SourcesDirectory)/eng/scripts/Prepare-IisConfiguration.ps1'
              arguments: '-PublishPath "$(publishPath)"'

          # Publish build artifact
          - task: PublishBuildArtifacts@1
            displayName: 'Publish artifact'
            inputs:
              PathtoPublish: '$(publishPath)'
              ArtifactName: '$(artifactName)'
              publishLocation: 'Container'

  # ============================================
  # Stage: Deploy to Development
  # ============================================
  - stage: DeployDev
    displayName: 'Deploy to Development'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
    variables:
      - name: environmentName
        value: 'Development'
      - name: aspnetCoreEnvironment
        value: 'Development'
    jobs:
      - deployment: DeployToDevVM
        displayName: 'Deploy to Dev IIS Server'
        environment:
          name: 'mudblazor-mcp-dev'
          resourceType: VirtualMachine
        strategy:
          runOnce:
            deploy:
              steps:
                - template: templates/deploy-iis.yaml
                  parameters:
                    artifactName: '$(artifactName)'
                    websiteName: '$(iisWebsiteName)-Dev'
                    appPoolName: '$(iisAppPoolName)-Dev'
                    physicalPath: '$(iisPhysicalPath)-Dev'
                    environment: '$(aspnetCoreEnvironment)'
                    port: 5181
            routeTraffic:
              steps:
                - script: echo "Routing traffic to new deployment..."
                  displayName: 'Route traffic'
            postRouteTraffic:
              steps:
                - task: PowerShell@2
                  displayName: 'Verify deployment health'
                  inputs:
                    targetType: 'filePath'
                    filePath: '$(Build.SourcesDirectory)/eng/scripts/Test-DeploymentHealth.ps1'
                    arguments: '-Port 5181 -AppPoolName "$(iisAppPoolName)-Dev" -PhysicalPath "$(iisPhysicalPath)-Dev" -MaxRetries 5 -RetryDelaySeconds 10'
            on:
              failure:
                steps:
                  - script: echo "Deployment failed. Consider rollback."
                    displayName: 'Handle deployment failure'
              success:
                steps:
                  - script: echo "Development deployment successful!"
                    displayName: 'Log deployment success'

  # ============================================
  # Stage: Deploy to Production
  # ============================================
  - stage: DeployProd
    displayName: 'Deploy to Production'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    variables:
      - name: environmentName
        value: 'Production'
      - name: aspnetCoreEnvironment
        value: 'Production'
    jobs:
      - deployment: DeployToProdVM
        displayName: 'Deploy to Production IIS Server'
        environment:
          name: 'mudblazor-mcp-prod'
          resourceType: VirtualMachine
        strategy:
          runOnce:
            preDeploy:
              steps:
                - script: echo "Preparing production deployment..."
                  displayName: 'Run pre-deployment checks'
            deploy:
              steps:
                - template: templates/deploy-iis.yaml
                  parameters:
                    artifactName: '$(artifactName)'
                    websiteName: '$(iisWebsiteName)'
                    appPoolName: '$(iisAppPoolName)'
                    physicalPath: '$(iisPhysicalPath)'
                    environment: '$(aspnetCoreEnvironment)'
                    port: 5180
            routeTraffic:
              steps:
                - script: echo "Routing traffic to new deployment..."
                  displayName: 'Route traffic'
            postRouteTraffic:
              steps:
                - task: PowerShell@2
                  displayName: 'Verify deployment health'
                  inputs:
                    targetType: 'filePath'
                    filePath: '$(Build.SourcesDirectory)/eng/scripts/Test-DeploymentHealth.ps1'
                    arguments: '-Port 5180 -AppPoolName "$(iisAppPoolName)" -PhysicalPath "$(iisPhysicalPath)" -MaxRetries 5 -RetryDelaySeconds 10'
            on:
              failure:
                steps:
                  - script: echo "Deployment failed. Consider rollback."
                    displayName: 'Handle deployment failure'
              success:
                steps:
                  - script: echo "Production deployment successful!"
                    displayName: 'Log deployment success'
